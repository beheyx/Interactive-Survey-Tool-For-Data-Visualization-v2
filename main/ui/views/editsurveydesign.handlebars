<head>
  <title>Editing {{name}}</title>
</head>

<!-- Edit Survey Design Page -->
<div class="page-actions">
  <a href="/existing-survey-designs" class="back-button">‚Üê Back to Survey Designs</a>
</div>

<div class="editor-header">
    <div class="editor-title">
        <h2>Editing {{name}}</h2>
    </div>
    <div class="editor-actions">
        <button type="submit" form="survey-settings" class="action-button">Save Changes</button>
        <button type="button" class="action-button action-button-success" id="publishButton">Publish</button>
        <form id="deleteDesignForm" action="/surveyDesigns/{{id}}/DELETE" method="POST" style="display:inline;">
            <button type="button" class="action-button action-button-danger" onclick="showDeleteDesignModal()">
                Delete
            </button>
        </form>
        <a class="help-tooltip" data-faq-id="14" href="#">?</a>
    </div>
</div>
<hr style="margin: 16px 0;">
<ul class="nav nav-tabs" role="tablist">
  <li class="nav-item">
    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#questions" role="tab">
      Survey Questions
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#settings" role="tab">
      Survey Settings
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#preview" role="tab">
      Preview Survey
    </button>
  </li>
</ul>

<div class="tab-content mt-3">
    <!--QUESTIONS-->
  <div class="tab-pane fade show active" id="questions" role="tabpanel">
    <h2>Questions<a class="help-tooltip" data-faq-id="7" href="#">?</a></h2>
    {{#each questions}}
        {{> questionListItem visualURL=../visualURL}}
    {{/each}}
    <p>{{questionError}}</p>
    <form action="/surveyDesigns/{{id}}/questions" method="POST">
        <button class="action-button" type="submit">+ Add Question</button>
    </form>
  </div>

    <!--SETTINGS-->
  <div class="tab-pane fade" id="settings" role="tabpanel">
    <form id="survey-settings" action="/surveyDesigns/{{id}}/PATCH" method="POST">
        <h2>Survey Details<a class="help-tooltip" data-faq-id="7" href="#">?</a></h2>
        <br>
        <h3>Survey Title</h3>
        <p>This is the title that is visible to participants.</p>
        <input class="form-control" type="text" id="title" name="title" value="{{title}}" placeholder="Enter survey title">
        <br>
        <h3>Introduction Text</h3>
        <p>This is the text the participant sees before starting the survey.</p>
        <textarea class="form-control" type="text" id="introText" name="introText" rows="4" cols="50" placeholder="Your introduction text here">{{introText}}</textarea>
        <br>
        <h3>Conclusion Text</h3>
        <p>This is the text the participant sees after completing the survey.</p>
        <textarea class="form-control" type="text" id="conclusionText" name="conclusionText" rows="4" cols="50" placeholder="Your conclusion text here">{{conclusionText}}</textarea>
    </form>
  </div>

    <!--PREVIEW-->
  <div class="tab-pane fade" id="preview" role="tabpanel">
    <div class="survey-preview">
      <p class="preview-note">This is how your survey will appear to participants.</p>

      <!-- Welcome Screen Preview -->
      <div class="preview-section preview-welcome">
        <h3>Welcome Screen</h3>
        <div class="preview-card">
          <h2 class="preview-title">{{#if title}}{{title}}{{else}}<em>No title set</em>{{/if}}</h2>
          <div class="preview-intro">
            {{#if introText}}
              <p>{{introText}}</p>
            {{else}}
              <p class="preview-placeholder"><em>No introduction text set</em></p>
            {{/if}}
          </div>
          <button class="preview-button" disabled>Start Survey</button>
        </div>
      </div>

      <!-- Questions Preview -->
      <div class="preview-section preview-questions">
        <h3>Questions</h3>
        {{#each questions}}
          <div class="preview-card preview-question-card">
            <div class="preview-question-header">
              <strong>Question {{number}}.</strong>
              {{#if required}}<span class="preview-required">*required</span>{{/if}}
            </div>
            <p class="preview-question-text">{{#if text}}{{text}}{{else}}<em>No question text</em>{{/if}}</p>

            {{#if visualizationContentId}}
              <div class="preview-visualization">
                <iframe
                  src="{{../visualURL}}/{{visualizationContentId}}?highlight=true&static=true"
                  title="Visualization Preview"
                  class="preview-iframe"
                  style="border: 1px solid #e5e7eb; border-radius: 12px;"
                ></iframe>
              </div>
            {{/if}}

            <div class="preview-answer-area">
              <p class="preview-answer-label"><strong>{{#if prompt}}{{prompt}}{{else}}Your answer:{{/if}}</strong></p>
              {{#if (eq type "Short Answer")}}
                <textarea class="preview-textarea" disabled placeholder="Participant's answer will appear here..."></textarea>
              {{else if (eq type "Multiple Choice")}}
                <div class="preview-choices">
                  {{#each choices}}
                    <label class="preview-choice">
                      <input type="checkbox" disabled> {{this}}
                    </label>
                  {{/each}}
                  {{#unless choices}}<em>No choices defined</em>{{/unless}}
                </div>
              {{else if (eq type "Radio Choice")}}
                <div class="preview-choices">
                  {{#each choices}}
                    <label class="preview-choice">
                      <input type="radio" disabled> {{this}}
                    </label>
                  {{/each}}
                  {{#unless choices}}<em>No choices defined</em>{{/unless}}
                </div>
              {{else}}
                <p class="preview-placeholder"><em>{{type}}</em></p>
              {{/if}}
            </div>
          </div>
        {{else}}
          <div class="preview-card">
            <p class="preview-placeholder"><em>No questions added yet</em></p>
          </div>
        {{/each}}
      </div>

      <!-- Conclusion Screen Preview -->
      <div class="preview-section preview-conclusion">
        <h3>Conclusion Screen</h3>
        <div class="preview-card">
          <h2 class="preview-title">Thank You!</h2>
          <div class="preview-conclusion-text">
            {{#if conclusionText}}
              <p>{{conclusionText}}</p>
            {{else}}
              <p class="preview-placeholder"><em>No conclusion text set</em></p>
            {{/if}}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<br>


<!-- popup windows -->
<!-- Delete Survey Design Modal -->
<div id="deleteDesignModal" class="delete-modal" style="display:none;">
  <div class="delete-modal-content">
    <h3>Delete Survey Design?</h3>
    <p>This action cannot be undone.</p>

    <div class="delete-modal-buttons">
      <button type="button" class="delete-btn-cancel" onclick="hideDeleteDesignModal()">Cancel</button>
      <button type="button" class="delete-btn-confirm" onclick="confirmDeleteDesign()">Delete</button>
    </div>
  </div>
</div>

<!-- some HTML referenced from https://www.geeksforgeeks.org/how-to-create-popup-box-using-html-and-css/ section "Using Display Property"-->
<div class="popup" id="publishSurveyPopup">
    <div class="popup-content">
        <h2>Publish {{name}}</h2>
        <br>
        <form action="/surveyDesigns/{{id}}/publishedSurveys" method="POST">
            
            <label for="openDateTime">Open time<a class="help-tooltip" data-faq-id="15" href="#">?</a>:</label>
            <input class="form-control" type="datetime-local" id="openDateTime" name="openDateTime" value="{{today}}" min="{{today}}"/>
            <br>
            <label for="closeDateTime">Close time<a class="help-tooltip" data-faq-id="15" href="#">?</a>:</label>
            <input class="form-control" type="datetime-local" id="closeDateTime" name="closeDateTime" value="{{tomorrow}}" min="{{today}}"/>
            <br>
            <label for="name">Name<a class="help-tooltip" data-faq-id="8" href="#">?</a>:</label>
            <input class="form-control" type="text" name="name" placeholder="survey name" value="{{name}}">
            <br><br>
            <button class="popup-create-button" id="publish-survey-button" type="submit">Publish</button>
        </form>
        <br>
        <button type="button" class="popup-cancel-button" onclick="window.location.hash=''">Cancel</button>
    </div>
</div>


<script>
function showDeleteDesignModal() {
  document.getElementById('deleteDesignModal').style.display = 'flex';
}

function hideDeleteDesignModal() {
  document.getElementById('deleteDesignModal').style.display = 'none';
}

function confirmDeleteDesign() {
  document.getElementById('deleteDesignForm').submit();
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {

  // Publish validation
  const publishButton = document.getElementById('publishButton');
  if (publishButton) {
    publishButton.addEventListener('click', function() {
      // Get all question blocks and check for valid questions
      const questionBlocks = document.querySelectorAll('.question-block');

      if (questionBlocks.length === 0) {
        alert('Cannot publish: Please add at least one question to your survey.');
        return;
      }

      // Check if at least one question has text (bg-light class indicates it has text)
      let hasValidQuestion = false;
      questionBlocks.forEach(function(block) {
        if (block.querySelector('.bg-light')) {
          hasValidQuestion = true;
        }
      });

      if (!hasValidQuestion) {
        alert('Cannot publish: Please fill in the text for at least one question.');
        return;
      }

      // All validations passed, show the publish popup
      window.location.hash = 'publishSurveyPopup';
    });
  }

  function renumberDomQuestions() {
    const blocks = document.querySelectorAll('.question-block');
    blocks.forEach((b, i) => {
      const numEl = b.querySelector('.question-number');
      if (numEl) numEl.textContent = String(i + 1);
    });
  }
  const forms = document.querySelectorAll('.question-move-form');

  forms.forEach(function (form) {
    form.addEventListener('submit', async function (e) {
      e.preventDefault();  // don't do full-page navigation

      const direction = form.dataset.direction;
      const block = form.closest('.question-block');
      if (!block) return;

      // Find neighbor block
      let neighbor = (direction === 'up')
        ? block.previousElementSibling
        : block.nextElementSibling;

      // Skip non-question siblings (just in case)
      while (neighbor && !neighbor.classList.contains('question-block')) {
        neighbor = (direction === 'up')
          ? neighbor.previousElementSibling
          : neighbor.nextElementSibling;
      }

      if (!neighbor) {
        // first/last question: nothing to move
        return;
      }

      try {
        const res = await fetch(form.action, {
          method: 'POST',
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        if (!res.ok) {
          throw new Error('Move failed with status ' + res.status);
        }

        // Swap DOM position
        const parent = block.parentNode;
        if (direction === 'up') {
          parent.insertBefore(block, neighbor);
        } else {
          parent.insertBefore(neighbor, block);
        }

        // Renumber all visible question numbers based on DOM order
        renumberDomQuestions();


      } catch (err) {
        console.error(err);
        // Fallback: full reload if something goes wrong
        window.location.reload();
      }
    });
  });
});
</script>
