<head>
  <title>Surveys</title>
</head>

<!-- Survey Designs Page -->
<main class="existing-page">
  <div class="page-header">
    <h2>Your Survey Designs</h2>
    <div class="header-actions">
      <button class="bulk-delete-btn" id="bulkDeleteSurveyDesigns" style="display: none;">Delete Selected</button>
      <a class="action-button" href="#surveyDesignsPopup">+ New Survey Design</a>
    </div>
  </div>

  <div class="table-container">
    {{#if surveyDesigns}}
      <table class="data-table">
        <thead>
          <tr>
            <th class="col-checkbox">
              <input type="checkbox" id="selectAllSurveyDesigns" class="table-checkbox">
            </th>
            <th class="col-name">Name</th>
            <th>Created</th>
            <th>Last Modified</th>
            <th class="actions-header">Actions</th>
          </tr>
        </thead>
        <tbody>
          {{#each surveyDesigns}}
            <tr>
              <td class="col-checkbox">
                <input type="checkbox" class="row-checkbox" data-id="{{id}}" data-type="surveyDesign">
              </td>
              <td class="col-name">
                <a href="/surveyDesigns/{{id}}" class="table-link">{{name}}</a>
              </td>
              <td>{{createdAt}}</td>
              <td>{{updatedAt}}</td>
              <td class="actions-cell">
                <a class="table-btn edit-btn" href="/surveyDesigns/{{id}}">Edit</a>
              </td>
            </tr>
          {{/each}}
        </tbody>
      </table>
    {{else}}
      <div class="empty-state">
        <p>No survey designs yet. Create your first one!</p>
        <a class="action-button" href="#surveyDesignsPopup">+ New Survey Design</a>
      </div>
    {{/if}}

    {{#if surError}}
      <p class="error-message">{{surError}}</p>
    {{/if}}
  </div>
</main>

<!-- New Survey Design Popup -->
<div class="popup" id="surveyDesignsPopup">
  <div class="popup-content">
    <h2>Create a New Survey Design</h2>
    <form action="/surveyDesigns" method="POST">
      <input type="text" name="name" placeholder="survey design name" />
      <button class="popup-create-button" id="create-survey-design-button">Create</button>
    </form>
    <button type="button" class="popup-cancel-button" onclick="window.location.hash=''">Cancel</button>
  </div>
</div>

<script>
// Bulk select/delete functionality for survey designs
(function() {
  const selectAll = document.getElementById('selectAllSurveyDesigns');
  const rowCheckboxes = document.querySelectorAll('.row-checkbox[data-type="surveyDesign"]');
  const bulkDeleteBtn = document.getElementById('bulkDeleteSurveyDesigns');

  // Select all checkbox
  if (selectAll) {
    selectAll.addEventListener('change', function() {
      rowCheckboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });
      toggleBulkDeleteButton();
    });
  }

  // Individual checkboxes
  rowCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const allChecked = Array.from(rowCheckboxes).every(cb => cb.checked);
      const someChecked = Array.from(rowCheckboxes).some(cb => cb.checked);
      if (selectAll) {
        selectAll.checked = allChecked;
        selectAll.indeterminate = someChecked && !allChecked;
      }
      toggleBulkDeleteButton();
    });
  });

  // Show/hide bulk delete button
  function toggleBulkDeleteButton() {
    const selectedCount = Array.from(rowCheckboxes).filter(cb => cb.checked).length;
    if (bulkDeleteBtn) {
      bulkDeleteBtn.style.display = selectedCount > 0 ? 'inline-block' : 'none';
      bulkDeleteBtn.textContent = `Delete Selected (${selectedCount})`;
    }
  }

  // Bulk delete handler
  if (bulkDeleteBtn) {
    bulkDeleteBtn.addEventListener('click', async function() {
      const selected = Array.from(rowCheckboxes).filter(cb => cb.checked);
      const count = selected.length;

      if (count === 0) return;

      if (confirm(`Are you sure you want to delete ${count} survey design${count > 1 ? 's' : ''}?`)) {
        // Delete each selected item sequentially
        for (const checkbox of selected) {
          const id = checkbox.getAttribute('data-id');
          try {
            await fetch(`/surveyDesigns/${id}/DELETE`, {
              method: 'POST'
            });
          } catch (error) {
            console.error(`Failed to delete survey design ${id}:`, error);
          }
        }
        // Reload page after all deletes complete
        window.location.reload();
      }
    });
  }
})();
</script>
