<head>
  <title>Visualizations</title>
</head>

<!-- Images Page -->
<main class="existing-page">
  <div class="page-header">
    <h2>Your Visualizations</h2>
    <div class="header-actions">
      <button class="bulk-delete-btn" id="bulkDeleteVisualizations" style="display: none;">Delete Selected</button>
      <a class="action-button" href="#visualizationsPopup">+ New Visualization</a>
    </div>
  </div>

  <div class="table-container">
    {{#if visualizations}}
      <table class="data-table">
        <thead>
          <tr>
            <th class="col-checkbox">
              <input type="checkbox" id="selectAllVisualizations" class="table-checkbox">
            </th>
            <th class="col-name">Name</th>
            <th>Created</th>
            <th>Last Modified</th>
            <th class="actions-header">Actions</th>
          </tr>
        </thead>
        <tbody>
          {{#each visualizations}}
            <tr>
              <td class="col-checkbox">
                <input type="checkbox" class="row-checkbox" data-id="{{id}}" data-type="visualization">
              </td>
              <td class="col-name">
                <div class="name-cell">
                  <a href="/visualizations/{{id}}" class="table-link">{{name}}</a>
                  <button class="rename-icon" data-id="{{id}}" data-name="{{name}}" title="Rename">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                      <path d="m15 5 4 4"/>
                    </svg>
                  </button>
                </div>
              </td>
              <td>{{createdAt}}</td>
              <td>{{updatedAt}}</td>
              <td class="actions-cell">
                <a class="table-btn edit-btn" href="/visualizations/{{id}}">Edit</a>
              </td>
            </tr>
          {{/each}}
        </tbody>
      </table>
    {{else}}
      <div class="empty-state">
        <p>No visualizations yet. Create your first one!</p>
        <a class="action-button" href="#visualizationsPopup">+ New Visualization</a>
      </div>
    {{/if}}

    {{#if visError}}
      <p class="error-message">{{visError}}</p>
    {{/if}}
  </div>
</main>

<!-- New Visualization Popup -->
<div class="popup" id="visualizationsPopup">
  <div class="popup-content">
    <h2>Create a New Visualization</h2>
    <form action="/visualizations" method="POST">
      <input type="text" name="name" placeholder="visualization name" />
      <button class="popup-create-button" id="create-visualization-button">Create</button>
    </form>
    <button type="button" class="popup-cancel-button" onclick="window.location.hash=''">Cancel</button>
  </div>
</div>

<!-- Rename Visualization Popup -->
<div class="popup" id="renameVisualizationPopup">
  <div class="popup-content">
    <h2>Rename Visualization</h2>
    <form id="renameVisualizationForm">
      <input type="hidden" id="renameVisualizationId" />
      <input type="text" id="renameVisualizationName" placeholder="new name" />
      <button type="submit" class="popup-create-button">Save</button>
    </form>
    <button type="button" class="popup-cancel-button" onclick="window.location.hash=''">Cancel</button>
  </div>
</div>

<script>
// Rename functionality for visualizations
(function() {
  const renameButtons = document.querySelectorAll('.rename-icon');
  const renameForm = document.getElementById('renameVisualizationForm');
  const renameIdInput = document.getElementById('renameVisualizationId');
  const renameNameInput = document.getElementById('renameVisualizationName');

  // Open rename popup when clicking rename button
  renameButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.getAttribute('data-id');
      const name = this.getAttribute('data-name');
      renameIdInput.value = id;
      renameNameInput.value = name;
      window.location.hash = 'renameVisualizationPopup';
      renameNameInput.focus();
      renameNameInput.select();
    });
  });

  // Handle rename form submission
  if (renameForm) {
    renameForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const id = renameIdInput.value;
      const newName = renameNameInput.value.trim();

      if (!newName) return;

      try {
        const response = await fetch(`/visualizations/${id}/PATCH`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: newName })
        });

        if (response.ok) {
          window.location.reload();
        } else {
          alert('Failed to rename visualization');
        }
      } catch (error) {
        console.error('Failed to rename visualization:', error);
        alert('Failed to rename visualization');
      }
    });
  }
})();

// Bulk select/delete functionality for visualizations
(function() {
  const selectAll = document.getElementById('selectAllVisualizations');
  const rowCheckboxes = document.querySelectorAll('.row-checkbox[data-type="visualization"]');
  const bulkDeleteBtn = document.getElementById('bulkDeleteVisualizations');

  // Select all checkbox
  if (selectAll) {
    selectAll.addEventListener('change', function() {
      rowCheckboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });
      toggleBulkDeleteButton();
    });
  }

  // Individual checkboxes
  rowCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const allChecked = Array.from(rowCheckboxes).every(cb => cb.checked);
      const someChecked = Array.from(rowCheckboxes).some(cb => cb.checked);
      if (selectAll) {
        selectAll.checked = allChecked;
        selectAll.indeterminate = someChecked && !allChecked;
      }
      toggleBulkDeleteButton();
    });
  });

  // Show/hide bulk delete button
  function toggleBulkDeleteButton() {
    const selectedCount = Array.from(rowCheckboxes).filter(cb => cb.checked).length;
    if (bulkDeleteBtn) {
      bulkDeleteBtn.style.display = selectedCount > 0 ? 'inline-block' : 'none';
      bulkDeleteBtn.textContent = `Delete Selected (${selectedCount})`;
    }
  }

  // Bulk delete handler
  if (bulkDeleteBtn) {
    bulkDeleteBtn.addEventListener('click', async function() {
      const selected = Array.from(rowCheckboxes).filter(cb => cb.checked);
      const count = selected.length;

      if (count === 0) return;

      if (confirm(`Are you sure you want to delete ${count} visualization${count > 1 ? 's' : ''}?`)) {
        // Delete each selected item sequentially
        for (const checkbox of selected) {
          const id = checkbox.getAttribute('data-id');
          try {
            await fetch(`/visualizations/${id}/DELETE`, {
              method: 'POST'
            });
          } catch (error) {
            console.error(`Failed to delete visualization ${id}:`, error);
          }
        }
        // Reload page after all deletes complete
        window.location.reload();
      }
    });
  }
})();
</script>
